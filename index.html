<!doctype html>
<html ng-app="myApp">
  <head>
    <title>My Angular App</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <script type="text/javascript">
      var myApp = angular.module('myApp', []);

      myApp.controller('helloCtrl', function($scope) {
        $scope.hi = 'world';
      });
      myApp.controller('contactCtrl', function($scope, $timeout) {
        $scope.hi = 'contactCtrl';
        $scope.counter = 0;
        var increase = function() {
          $scope.counter++;
          $timeout(increase, 1000);
        }
        increase();
      });
      myApp.directive('a', ['anRouter', function(anRouter) {
        return {
          link: function(scope, element, attrs) {
            element.bind('click', function(e) {
              var href = event.target.getAttribute('href');
              anRouter.goTo(href);
              console.log(href);
              console.log('click');
              e.preventDefault();
            })
          }
        }
      }]);
      myApp.directive('anView', ['anRouter', '$compile', '$controller', '$timeout', '$templateCache', '$rootScope',
        function(anRouter, $compile, $controller, $timeout, $templateCache, $rootScope) {
        console.log('called');
        anRouter.doStuff();
        console.log('compile ', $compile);
        return {
          restrict: 'E',
          transclude: true,
          scope: {},
          templateUrl: 'templates/contact.html',
          link: function(scope, element, attrs) {

            $rootScope.$on('anStateChange', function(to) {
              console.log('state changed to ', to);
              var subscope = scope.$new(); 
              console.log('subscope', subscope);
              console.log('$templateCache', $templateCache);
              console.log($templateCache.get('templates/contact.html'))
              var el = $compile($templateCache.get('templates/contact.html'))(subscope);
              console.log('el', el);
              console.log($controller);
              $controller('contactCtrl', {$scope: subscope});
              $timeout(function() {
                element.append(el);
              });
              console.log('element', element);
            

             });



            var subscope = scope.$new(); 
            console.log('subscope', subscope);
            console.log('$templateCache', $templateCache);
            console.log($templateCache.get('templates/contact.html'))
            var el = $compile($templateCache.get('templates/contact.html'))(subscope);
            console.log('el', el);
            console.log($controller);
            $controller('contactCtrl', {$scope: subscope});
            element.append(el);
            console.log('element', element);
            
            
          }
        }
      }]);

      myApp.service('anRouter', ['$rootScope', function($rootScope) {
        console.log('service called');
        this.doStuff = function() {
          console.log('wll do stuff');
        };
        this.goTo = function(href) {
          console.log('href is ', href);
          $rootScope.$emit('anStateChange', href);
          //this.$emit('hello');
          console.log(this);
        }
      }]);
    </script>
  </head>
  <body>
    Write some text in textbox:
    <input type="text" ng-model="sometext" />
 
    <h1>Hello {{ sometext }}</h1>
    <div ng-controller="helloCtrl">
      {{ hi }}
    </div>
    <an-view></an-view>

    <script id="templates/contact.html" type="text/ng-template">
      <div>
        i am the contact template {{ hi }}: my counter is {{ counter }}
        <a href="#list">go to list</a>
      </div>
    </script>

    <script id="templates/list.html" type="text/ng-template">
      <div>
        This is the List View
      </div>
    </script>
  </body>
</html>