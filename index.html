<!doctype html>
<html ng-app="myApp">
  <head>
    <title>My Angular App</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <script type="text/javascript">
      var myApp = angular.module('myApp', []);

      myApp.controller('helloCtrl', function($scope) {
        console.log('hello Ctrl');
        $scope.hi = 'world';
      });
      myApp.controller('contactCtrl', function($scope, $timeout) {
        console.log('contact Ctrl');
        $scope.hi = 'contactCtrl';
        $scope.counter = 0;
        var increase = function() {
          $scope.counter++;
          $timeout(increase, 1000);
        }
        increase();
      });
      myApp.directive('a', ['anRouter', function(anRouter) {
        return {
          link: function(scope, element, attrs) {
            element.bind('click', function(e) {
              var href = e.target.getAttribute('href');
              anRouter.goTo(href);
              console.log(href);
              console.log('click');
              e.preventDefault();
            })
          }
        }
      }]);



      myApp.directive('anView', ['anRouter', '$compile', '$controller', '$timeout', '$templateCache', '$rootScope',
        function(anRouter, $compile, $controller, $timeout, $templateCache, $rootScope) {
        console.log('called');
        anRouter.doStuff();

        return {
          restrict: 'E',
          transclude: true,
          scope: {},
          link: function(scope, element, attrs) {
            var views = {}, scopes = {};
            var structure = {
              'search': 0,
                'start': 1,
                  'list': 2,
                'contact': 1,
                  'contact_2': 2,
                'payment': 1,
                  'payment_2': 2,
              'profile': 0,
            };
            var animationTimeout, cur_el, new_el;


            $rootScope.$on('anStateChange', function(e, to, opts) {
              console.log(opts);
              opts = opts || {};
              typeof(opts.animate) == 'undefined' && (opts.animate = true);  // default

              console.log('state changed to ', to);
              if (animationTimeout) {
                clearTimeout(animationTimeout);
                resolveAnimation();
                animationTimeout = null;
              }
              // clear existing controllers
              if (scopes[to]) {
                var subscope = scopes[to];
              } else {
                var subscope = scope.$new();
                $controller('contactCtrl', {$scope: subscope});
                scopes[to] = subscope;
              }

              var el = $compile($templateCache.get('templates/'+ to +'.html'))(subscope);
              views[to] = el;

              el[0].classList.add('anView');

              // animate in
              var anim_out, anim_out;
              for (var it in structure) {
                if (it == to) {
                  if (opts.invertDir) {
                    anim_in = ['rotateIn', 'fadeInBottom', 'fadeInLeft'][structure[it]];
                    anim_out = ['rotateOut', '', 'fadeOutRight'][structure[it]];
                  } else {
                    anim_in = ['rotateIn', 'fadeInBottom', 'fadeInRight'][structure[it]];
                    anim_out = ['rotateOut', '', 'fadeOutLeft'][structure[it]];
                  }
                }
              }

              console.log('anim_in', anim_in);
              console.log('anim_out', anim_out);

              // after animation finished
              animationTimeout = setTimeout(function() {
                resolveAnimation();
                animationTimeout = null;
              }, 2000);

              // add element to the dom, animate in
              $timeout(function() {
                element.append(el);
                // animate out
                if(opts.animate) {
                  el[0].classList.add(anim_in);
                  el[0].classList.add('ng-enter-active');
                  cur_el && anim_out && cur_el[0].classList.add(anim_out);
                }
              });

              console.log('element', el);
              new_el = el;

              function resolveAnimation() {
                new_el[0].classList.remove(anim_in);
                new_el[0].classList.remove('ng-enter-active');
                cur_el && element[0].removeChild(cur_el[0]);
                cur_el = new_el;
              }
            });
          }
        }
      }]);

      myApp.service('anRouter', ['$rootScope', function($rootScope) {
        console.log('service called');
        $rootScope.anHistory = [];
        this.doStuff = function() {
          console.log('wll do stuff');
        };

        this.goTo = function(href, opts) {
          opts = opts ||{};
          console.log('href is ', href);
          // check if we are already on this page
          var anHistory = $rootScope.anHistory;
          if (anHistory.length > 0 && anHistory[anHistory.length - 1] == href) {
            console.log('you are already here');
            return;
          }

          // check if the page was previosly visited
          if (anHistory.length > 1 && anHistory[anHistory.length - 2] == href) {
            console.log('go back');
            opts.invertDir = true;
            history.replaceState({}, '', '#'+href);
            $rootScope.anHistory.pop();

          } else {
            history.pushState({}, "", '#'+href);
            $rootScope.anHistory.push(href);
          }


          $rootScope.$emit('anStateChange', href, opts);
          //this.$emit('hello');
          console.log(this);
        };

        var that = this;
        // support prowser back forth navigation
        window.onpopstate = function(event) {
          console.log("location: " + document.location + ", state: " + JSON.stringify(event.state));
          console.log(event);
          var to = location.hash.substring(1);
          console.log('will go to ', to);
          debugger;
          that.goTo(to);

        };

        // initialliy go to the default (0) page
        var that = this;
        setTimeout(function() {
          var to = location.hash.substring(1) || 'search';
          that.goTo(to, {animate: false});
        });
      }]);
    </script>
  </head>
  <body>
    <div id='c' style='border: 1px solid black;'>
      Write some text in textbox:
      <input type="text" ng-model="sometext" />
      {{ anHistory }}
      <h1>Hello {{ sometext }}</h1>
      <div ng-controller="helloCtrl">
        {{ hi }}
      </div>
      links:
      <a href="profile">Profile</a>
      <a href="search">Search</a>
      <br />
      <a href="start">start</a>
      <a href="payment">payment</a>
      <a href="contact">contact</a>
      <br />
      <a href="list">List</a>
      <a href="payment_2">payment2</a>
      <a href="contact_2">contact2</a>

      <an-view class="anWrap"></an-view>
    </div>

    <script id="templates/contact.html" type="text/ng-template">
      <div>
        i am the contact template {{ hi }}: my counter is {{ counter }}
        <a href="#list">go to list</a>
        <br />
        using scope id: {{ $id }}
      </div>
    </script>

    <script id="templates/list.html" type="text/ng-template">
      <div>
        This is the List anView
        <br />
        using scope id: {{ $id }}
      </div>
    </script>

    <script id="templates/search.html" type="text/ng-template">
      <div>
        <h1>Search</h1>
      </div>
    </script>
    <script id="templates/profile.html" type="text/ng-template">
      <div>
        <h1>Profile</h1>
      </div>
    </script>
    <script id="templates/start.html" type="text/ng-template">
      <div>
        <h1>Start</h1>
      </div>
    </script>
    <script id="templates/contact.html" type="text/ng-template">
      <div>
        <h1>Contact</h1>
      </div>
    </script>
    <script id="templates/payment.html" type="text/ng-template">
      <div>
        <h1>Payment</h1>
      </div>
    </script>
        <script id="templates/list.html" type="text/ng-template">
      <div>
        <h1>List</h1>
      </div>
    </script>
    <script id="templates/contact_2.html" type="text/ng-template">
      <div>
        <h1>Contact 2</h1>
      </div>
    </script>
    <script id="templates/payment_2.html" type="text/ng-template">
      <div>
        <h1>Payment 2</h1>
      </div>
    </script>



  </body>
  <script type="text/javascript">
    console.log('add listener');
    document.body.addEventListener('mousedown', function(e) {
      console.log('bubble', e);
    }, false);
      document.body.addEventListener('mousedown', function() { console.log('capture')}, true);

      // things we could track
      // scrollposition
      // activity
      // click position
      // touch movement
      // time on page (increase exponential time to ping server)

      // window.onbeforeunload = function (e) {, try eventually events

      // once: browser/ engine/ resolution
      </script>
</html>